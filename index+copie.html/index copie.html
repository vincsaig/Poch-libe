<!DOCTYPE html>
<html lang="fr">
	<head>
		<title>Poch'Lib</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="D:\OpenClassroom\P6\Poch-libe\CSS\book.css">
  	</head>
  	<body>
		<div id="myBooks">
			<h1 class="title">Poch'Lib</h1>
			<h2 class="h2">Nouveau Livre</h2>
			<button id="formLoad" type="submit" onclick="loadForm()">Ajouter un livre</button>
			<form>
				<label for="title" id ="titleInputLabel" hidden="true">Titre du livre</label>
				<input type="text" id="title" hidden="true">
				<label for="Author" id ="authorInputLabel" hidden="true">Auteur</label>
				<input type="text" id="author" hidden="true">
			</form>
			<button id="formSubmit" type="submit" onclick="get()" hidden="true">Search</button>
			<hr>
			<div id="books" class = "booklist"></div>
			<div id="content">
				<h2>Ma poch'liste</h2>
			</div>
			<script type = "text/javascript">
				function loadForm(){
					document.getElementById('formLoad').hidden = true;
					document.getElementById('titleInputLabel').hidden = false;
					document.getElementById('title').hidden = false;
					document.getElementById('authorInputLabel').hidden = false;
					document.getElementById('author').hidden = false;
					document.getElementById('formSubmit').hidden = false;
				}

				function get(){
					console.log('Bonjour');
					userAction();
				}

				const userAction = async () => {
					document.getElementById('books').innerHTML = "";
					let title = document.getElementById('title').value;
					let author = document.getElementById('author').value;
					console.log('https://www.googleapis.com/books/v1/volumes?q='+ title + '+inauthor:' + author)
					const response = await fetch('https://www.googleapis.com/books/v1/volumes?q='+ title + '+inauthor:' + author);
					const myJson = await response.json(); //extract JSON from the http response
					console.log(myJson);
					//console.log(JSON.stringify(myJson));
					//document.getElementById("livre").innerHTML = JSON.stringify(myJson);
					const bookArr = myJson.items;
					for(let i = 0 ; i < bookArr.length; i++){
						//document.getElementById('livre').insertAdjacentHTML('beforeend', myArr[i].id);
						//document.getElementById('livre').insertAdjacentHTML('beforeend', "<br>");
						bookProcessing(bookArr[i],i);
					}
					console.log(books)
				}

				function bookProcessing(bookInfo, bookNumber){
					let book = document.createElement("div");
					book.className = 'book';
					book.id = 'book'+bookNumber;

					const author = 'authors' in bookInfo.volumeInfo ? bookInfo.volumeInfo.authors[0] : 'Non renseigné';
					const title = 'title' in bookInfo.volumeInfo ? bookInfo.volumeInfo.title : 'Non renseigné';
					const description = 'description' in bookInfo.volumeInfo ? bookInfo.volumeInfo.description : 'Non renseigné';
					const thumbnail = 
					'imageLinks' 
					in 
					bookInfo.volumeInfo 
					?
					bookInfo.volumeInfo.imageLinks.thumbnail
					:
					"D:\\OpenClassroom\\P6\\images\\unavailable.png";

					bookElementProcessing(book,'title',title,bookNumber);
					bookElementProcessing(book,'id',bookInfo.id,bookNumber);
					bookElementProcessing(book,'author',author,bookNumber);
					bookElementProcessing(book,'description',description,bookNumber);
					bookImageProcessing(book,'thumbnail',thumbnail,bookNumber);
					
					let addBookFlag = document.createElement("span");
					addBookFlag.className = "flag";
					addBookFlag.id = "flagcard";
					addBookFlag.addEventListener('click', function handleClick(event){
						addToMyPochList(event);
					});
					addBookFlag.innerHTML = "<img src='D:\\OpenClassroom\\P6\\Poch-libe\\images\\bookmark.png' class='bookmark'>";
					book.appendChild(addBookFlag);

					document.getElementById('books').appendChild(book);
				}

				function bookElementProcessing(book,bookClassName,bookElement,bookNumber){
					let element = document.createElement("div");
					element.id = bookClassName+bookNumber;
					element.className = bookClassName;
					element.innerHTML = bookElement;
					book.appendChild(element);
				}

				function bookImageProcessing(book,imageClassName,image){
					let thumbnail = document.createElement("img");
					thumbnail.className = imageClassName;
					thumbnail.src = image ? image : "D:\\OpenClassroom\\P6\\images\\unavailable.png";
					book.appendChild(thumbnail);
				}

				function addToMyPochList(event){
					let library = "";

					if(sessionStorage.getItem("pochlist")){
						library = sessionStorage.getItem("pochlist");
					}

					console.log("ParentElement ID " + event.target.parentElement);
					var elem = document.getElementById(event.target.parentElement.parentElement.id);
					console.log(event.target.parentElement.parentElement.id.toString()[4]);
					var bookNumber = event.target.parentElement.parentElement.id.toString().slice(4);
					var bookId = document.getElementById("id"+bookNumber).innerHTML;
					event.target.parentElement.innerHTML = "<img src='D:\\OpenClassroom\\P6\\Poch-libe\\images\\trashcan.png' class='bookmark'>";
					console.log(bookId);

					if(library == ""){
						library = bookId;
					} else {
						library += " " + bookId;
					}
					console.log(library);
					sessionStorage.setItem("pochlist", library);

					document.getElementById('content').appendChild(elem);
				}
			</script>
		</div>
  	</body>
</html>